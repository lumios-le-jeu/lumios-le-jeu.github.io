<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lumios ‚Äì web proto</title>
<style>
  :root{
    --bg:#0b1020;
    --panel:#131a3a;
    --brand:#e65a6a;
    --green:#38d67a;
    --blue:#4da6ff;
    --red:#ff5a67;
    --gold:#ffd24a;
    --text:#fff;
    --hudH:56px;
  }

  /* Base */
  html,body{
    margin:0; padding:0; background:var(--bg); color:var(--text);
    font-family:Arial,Helvetica,sans-serif; height:100%;
    overflow:hidden;      /* plein √©cran, pas de scroll */
  }
  *{ touch-action: manipulation; } /* √©vite le double-tap zoom mobile */

  /* HUD (bandeau du haut) */
  #hud{
    position:fixed; inset:0 0 auto 0; height:var(--hudH);
    padding:8px calc(12px + env(safe-area-inset-right)) 8px calc(12px + env(safe-area-inset-left));
    display:flex; align-items:center; gap:12px;
    background:rgba(5,10,25,.65); backdrop-filter:blur(8px);
    z-index:50;
  }
  #clock{ font-weight:700; letter-spacing:.5px; }
  #powerRow{ display:flex; align-items:center; gap:10px; }
  #powerTrack{ width:120px; height:10px; background:#121836; border-radius:999px; overflow:hidden }
  #powBar{ height:100%; width:0%; background:var(--blue); }
  #powPct{ width:40px; text-align:right; }

  /* hamburger */
  #hamburger{
    width:40px; height:40px; border-radius:10px;
    border:2px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.08); color:#fff; font-size:20px; font-weight:800;
    display:inline-flex; align-items:center; justify-content:center;
  }

  /* badge joueur √† droite, reste dans l'√©cran */
  #badge{
    margin-left:auto;
    max-width:45vw;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-weight:800; font-size:16px;
    padding:8px 12px; border-radius:10px;
    color:#000; background:#6ab7ff;
    border:2px solid rgba(255,255,255,.15);
  }
  @media (max-width: 380px){
    #badge{ font-size:14px; max-width:54vw; padding:6px 8px; }
  }

  /* zone de jeu */
  #wrap{ position:relative; width:100vw; height:100vh; }
  #canvas{
    position:absolute; inset:var(--hudH) 0 0 0;   /* sous le HUD */
    width:100%; height:calc(100% - var(--hudH));
    display:block;
  }

  /* Menu d√©roulant (mobile & desktop) */
  .menu{
    position:fixed; top:var(--hudH); left:0; right:0;
    max-height:0; overflow:hidden;
    background:rgba(10,14,30,.95);
    transition:max-height .25s ease;
    z-index:60; padding:0 12px;
  }
  .menu.open{ max-height:70vh; }
  .menu-row{
    display:flex; align-items:center; gap:10px;
    padding:10px 4px; border-bottom:1px solid rgba(255,255,255,.08);
  }
  .menu .track{ flex:1; height:10px; background:#121836; border-radius:999px; overflow:hidden; }
  .menu .fill{ height:100%; width:0%; background:var(--blue); }
  .menu-actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px; padding:12px 0; }
  .menu .btn{ padding:10px 12px; border-radius:8px; font-weight:700; border:none; box-shadow:0 6px 16px rgba(0,0,0,.25); }
  .menu .buy{ grid-column:1/-1; text-align:center; text-decoration:none; background:#ff4d6d; color:#fff; }

  .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
  .g{background:var(--green)} .b{background:var(--blue)}
  .btn{display:block;width:100%;margin-top:6px;padding:10px 12px;border-radius:8px;text-align:center;font-weight:bold;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.25);border:none}
  #btnMode, #mBtnMode{background:var(--green);color:#000}
  #btnNext, #mBtnNext{background:#ffb74a;color:#000}
  #btnReplay, #mBtnReplay{background:var(--blue);color:#fff}

  /* message d'aide */
  #help{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:92px; color:#fff; opacity:.9; text-shadow:0 2px 8px rgba(0,0,0,.6);
    font-weight:700; font-size:18px; pointer-events:none;
  }

  /* Encadr√© narration (visible sur desktop, masqu√© sur petit √©cran) */
  #narration{
    position:fixed; top:calc(var(--hudH) + 12px); left:12px;
    width:280px; background:var(--panel); color:#fff;
    border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.25);
    padding:12px 14px; line-height:1.4; z-index:55;
  }
  #narration h4{ margin:0 0 6px 0; font-size:14px; opacity:.85; font-weight:700; letter-spacing:.5px }
  #narration p{ margin:0; font-size:14px }
  @media (max-width:768px){
    #narration{ display:none; }
  }
</style>
</head>
<body>

<!-- HUD -->
<div id="hud">
  <button id="hamburger" aria-label="Menu">‚ò∞</button>

  <div id="clock">00:00</div>

  <div id="powerRow">
    <span>Power</span>
    <div id="powerTrack"><div id="powBar"></div></div>
    <div id="powPct">0%</div>
  </div>

  <div id="badge">JOUEUR 1</div>
</div>

<!-- Menu d√©roulant -->
<div id="dropMenu" class="menu">
  <div class="menu-row">
    <span class="label">Power</span>
    <div class="track"><div class="fill" id="menuPowFill"></div></div>
    <b id="menuPowPct">0%</b>
  </div>
  <div class="menu-row">
    <span class="dot g"></span><span>Verts</span><b id="mCntG">0</b>
  </div>
  <div class="menu-row">
    <span class="dot b"></span><span>Bleus</span><b id="mCntB">0</b>
  </div>
  <div class="menu-actions">
    <button id="mBtnMode" class="btn">üåô Nuit</button>
    <button id="mBtnNext" class="btn">‚è≠Ô∏è Skip</button>
    <button id="mBtnReplay" class="btn">üîÑ Rejouer</button>
    <a id="mBtnBuy" class="btn buy" href="https://www.lumios-le-jeu.fr/" target="_blank" rel="noopener">
      üéÅ Pr√©commander un vrai Jeu Lumios pour No√´l
    </a>
    <a class="btn buy" style="background:#e65a6a" href="https://www.lumios-le-jeu.fr/pages/regles-du-jeu-lumios" target="_blank" rel="noopener">üìñ R√®gles</a>
  </div>
</div>

<!-- Zone de jeu -->
<div id="wrap">
  <canvas id="canvas"></canvas>
  <div id="help">Lancez la balle en visant les boules</div>
</div>

<!-- Encadr√© narration (desktop) -->
<div id="narration">
  <h4>Narration</h4>
  <p id="narrText">Bienvenue dans Lumios üü¢üîµ</p>
</div>

<script>
/* ===== Polyfill rAF ===== */
(function(){
  var v=['ms','moz','webkit','o'],i;
  for(i=0;i<v.length && !window.requestAnimationFrame;i++){
    window.requestAnimationFrame=window[v[i]+'RequestAnimationFrame'];
    window.cancelAnimationFrame=window[v[i]+'CancelAnimationFrame']||window[v[i]+'CancelRequestAnimationFrame'];
  }
  if(!window.requestAnimationFrame){
    window.requestAnimationFrame=function(cb){return setTimeout(function(){cb(Date.now());},16);};
    window.cancelAnimationFrame=function(id){clearTimeout(id);};
  }
})();

/* ===== Canvas + √©l√©ments HUD ===== */
const canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d');
const hudClock=document.getElementById('clock');
const powBar=document.getElementById('powBar');
const powPct=document.getElementById('powPct');
const badge=document.getElementById('badge');
const helpEl=document.getElementById('help');
const narrText=document.getElementById('narrText');

/* Menu */
const hamburger = document.getElementById('hamburger');
const dropMenu  = document.getElementById('dropMenu');
const mPowFill  = document.getElementById('menuPowFill');
const mPowPct   = document.getElementById('menuPowPct');
const mCntG     = document.getElementById('mCntG');
const mCntB     = document.getElementById('mCntB');

hamburger.onclick = () => dropMenu.classList.toggle('open');

document.getElementById('mBtnMode').onclick   = () => btnMode.click?.();
document.getElementById('mBtnNext').onclick   = () => document.getElementById('btnNext')?.click();
document.getElementById('mBtnReplay').onclick = () => document.getElementById('btnReplay')?.click();

/* ===== Sizing ===== */
function sizeCanvas(){
  const r=canvas.getBoundingClientRect();
  canvas.width = Math.max(1, Math.floor(r.width));
  canvas.height= Math.max(1, Math.floor(r.height));
  layout();
}
window.addEventListener('resize', sizeCanvas);

/* ===== Couleurs ===== */
const COLOR_RED   ='#ff5a67';
const COLOR_GREEN ='#38d67a';
const COLOR_BLUE  ='#4da6ff';
const COLOR_GOLD  ='#ffd24a';

/* ===== Param√®tres ===== */
const LUMIES_N=5, R_LUMIE=22, R_BALL=16;
const LUMIE_SPACING = R_LUMIE * 4;
const RESTIT=0.95;
const FRICTION = 0.985;   // balle jaune
const ROLL_F   = 0.980;   // lumies
const STOP_EPS = 0.04;

const POWER_K=0.09, MAX_DRAG=320;
const MAX_AIM_LEN = 120;           // fl√®che vis√©e
const BASE_ZONE_RATIO=0.16;        // zone de tir

// D√©tections robustes d‚Äôimpact/mouvement
const SPEED_EPS   = 0.06;  // vitesse min consid√©r√©e comme "bouge"
const IMPACT_EPS  = 0.12;  // vitesse normale minimale pour compter un impact
const COLOR_COOLDOWN = 600; // ms anti-spam couleur

/* ===== √âtat ===== */
let lumies=[], ball=null, drag=null, tStart=Date.now();
let mode="night"; // "night" ou "day"
let currentPlayer=1;                       // 1 ou 2
let playerColors={1:null,2:null};          // d√©fini lors de la 1√®re rouge touch√©e
let gainedThisTurn=0, lostThisTurn=0;
let gameOver=false, winColor=null, confetti=[];

/* suivi pour la narration */
let turnChanges=[];

/* ===== UI boutons "shadow" (utilis√©s par menu mobile) ===== */
const btnMode = {
  click: function(){
    if(mode==="night"){ mode="day"; this.text="‚òÄÔ∏è Jour"; }
    else { mode="night"; this.text="üåô Nuit"; }
  },
  set text(v){ /* no-op pour compat compat */ }
};
document.getElementById('btnNext') || (function(){ const b=document.createElement('button'); b.id='btnNext'; b.style.display='none'; document.body.appendChild(b); })();
document.getElementById('btnReplay') || (function(){ const b=document.createElement('button'); b.id='btnReplay'; b.style.display='none'; document.body.appendChild(b); })();

/* Actions */
document.getElementById('btnNext').onclick=function(){
  if(ball){ ball.active=false; ball.vx=0; ball.vy=0; }
  endOfTurn();
};
document.getElementById('btnReplay').onclick=function(){ resetGame(); };

/* Scores (uniquement pour le menu ‚Äî les compteurs desktop n'existent plus) */
function countColors(){let g=0,b=0;for(let i=0;i<lumies.length;i++){const c=lumies[i].color; if(c==='green')g++; else if(c==='blue')b++;}return {g,b};}
function updateScore(){
  const c=countColors();
  mCntG.textContent=c.g; mCntB.textContent=c.b;
}

/* ===== Init ===== */
function resetGame(){
  playerColors={1:null,2:null};
  currentPlayer=1;
  gainedThisTurn=0; lostThisTurn=0;
  turnChanges.length=0;
  gameOver=false; winColor=null; confetti.length=0;
  tStart=Date.now();
  helpEl.style.display = 'block';
  narrText.textContent = 'Nouveau tour. Lancez la balle !';
  layout();
}

function layout(){
  lumies=[];
  const midX=canvas.width*0.5;
  const midY=canvas.height*0.5;

  // Spacing responsive (mobile: compacte si n√©cessaire)
  let spacing=LUMIE_SPACING, startX=midX - spacing*(LUMIES_N-1)/2;
  const isMobile=(canvas.width<=768) || (window.innerHeight>window.innerWidth);
  if(isMobile){
    const marginX=Math.max(16, canvas.width*0.06);
    const usable = canvas.width - 2*(marginX + R_LUMIE);
    const fitSpacing = (LUMIES_N>1)? (usable/(LUMIES_N-1)) : 0;
    spacing = Math.min(LUMIE_SPACING, fitSpacing);
    const rowW = spacing*(LUMIES_N-1);
    startX = Math.max(marginX + R_LUMIE, midX - rowW/2);
  }

  for(let i=0;i<LUMIES_N;i++){
    const x=startX + i*spacing;
    lumies.push({x, y:midY, vx:0, vy:0, r:R_LUMIE, color:'red', lastHit:0});
  }

  const launchOffset = Math.max(56, canvas.height*0.14); // visible
  if(currentPlayer===1){
    ball={x:midX, y:canvas.height-launchOffset, vx:0, vy:0, r:R_BALL, active:false, age:0};
  }else{
    ball={x:midX, y:launchOffset, vx:0, vy:0, r:R_BALL, active:false, age:0};
  }

  gainedThisTurn=0; lostThisTurn=0;
  updateScore();
  updateBadge();
}

function updateBadge(){
  if(!playerColors[1]){
    badge.style.background = COLOR_BLUE;
    badge.textContent = "JOUEUR "+currentPlayer;
    return;
  }
  const meCol = playerColors[currentPlayer];
  badge.style.background = (meCol==='green')?COLOR_GREEN:COLOR_BLUE;
  badge.textContent = "JOUEUR "+currentPlayer+" - "+meCol.toUpperCase();
}

/* ===== Entr√©es ===== */
function getPos(e){const r=canvas.getBoundingClientRect(); let x,y;
  if(e.touches&&e.touches.length){x=e.touches[0].clientX-r.left;y=e.touches[0].clientY-r.top;}
  else{x=e.clientX-r.left;y=e.clientY-r.top;} return {x,y};}

function inBaseZone(y){
  const zone=canvas.height*BASE_ZONE_RATIO;
  return currentPlayer===1 ? (y>canvas.height-zone) : (y<zone);
}

canvas.addEventListener('mousedown',startDrag,{passive:false});
canvas.addEventListener('touchstart',startDrag,{passive:false});
function startDrag(e){
  if(gameOver) return;
  const p=getPos(e);
  if(!inBaseZone(p.y)) return;   // hors zone : ignore
  e.preventDefault();
  drag={sx:p.x,sy:p.y,x:p.x,y:p.y};
  helpEl.style.display = 'none';
  turnChanges.length=0; // on repart pour ce tir
}

canvas.addEventListener('mousemove',moveDrag,{passive:false});
canvas.addEventListener('touchmove',moveDrag,{passive:false});
function moveDrag(e){
  if(!drag) return;
  const p=getPos(e); drag.x=p.x; drag.y=p.y; updatePowerUI(drag);
}

canvas.addEventListener('mouseup',endDrag); canvas.addEventListener('mouseleave',endDrag);
canvas.addEventListener('touchend',endDrag);
function endDrag(e){
  if(!drag) return;
  let vx=drag.x-drag.sx, vy=drag.y-drag.sy, len=Math.hypot(vx,vy);
  if(len>5){
    const p=Math.min(len,MAX_DRAG);           // clamp puissance
    const ux=vx/len, uy=vy/len;
    const speed=p*POWER_K;
    ball.x=drag.sx; ball.y=drag.sy; ball.vx=ux*speed; ball.vy=uy*speed; ball.active=true; ball.age=0;
  }
  drag=null; updatePowerUI(null);
}

function updatePowerUI(d){
  if(!d){
    powPct.textContent='0%'; powBar.style.width='0%'; powBar.style.background=COLOR_BLUE;
    mPowPct.textContent='0%'; mPowFill.style.width='0%'; mPowFill.style.background=COLOR_BLUE;
    return;
  }
  let vx=d.x-d.sx, vy=d.y-d.sy, len=Math.hypot(vx,vy), p=Math.min(len,MAX_DRAG);
  const pct=Math.round((p/MAX_DRAG)*100);
  const col = pct<40?COLOR_BLUE:(pct<75?COLOR_GREEN:'#ffb74a');
  powPct.textContent=pct+'%'; powBar.style.width=pct+'%'; powBar.style.background=col;
  mPowPct.textContent=pct+'%'; mPowFill.style.width=pct+'%'; mPowFill.style.background=col;
}

/* ===== R√®gle couleurs + collecte pour narration ===== */
function onLumieHit(L){
  const before=L.color;
  let after=before;

  if(before==='red'){
    after = (Math.random()<0.5)?'green':'blue';
    L.color = after;
    if(!playerColors[1] && !playerColors[2]){
      playerColors[currentPlayer]=L.color;
      playerColors[(currentPlayer===1)?2:1] = (L.color==='green')?'blue':'green';
      updateBadge();
    }
  }else if(before==='green'){
    after='blue'; L.color='blue';
  }else if(before==='blue'){
    after='green'; L.color='green';
  }

  // log pour narration
  turnChanges.push({before, after});

  updateScore();
  checkWin();

  if(playerColors[1]){
    if(L.color===playerColors[currentPlayer] && before!==playerColors[currentPlayer]) gainedThisTurn++;
    if(before===playerColors[currentPlayer] && L.color!==playerColors[currentPlayer]) lostThisTurn++;
  }
}

/* Impact ‚Äúr√©el‚Äù uniquement */
function tryToggleOnMoveFromImpact(L, normalSpeed){
  const now = performance.now();
  if(!L.lastHit) L.lastHit = 0;
  if(now - L.lastHit < COLOR_COOLDOWN) return;          // cooldown
  if(normalSpeed < IMPACT_EPS) return;                  // trop faible
  if(Math.hypot(L.vx, L.vy) < SPEED_EPS) return;        // ne bouge pas vraiment
  onLumieHit(L);
  L.lastHit = now;
}

/* ===== Victoire ===== */
function checkWin(){const c=countColors(); if(c.g===LUMIES_N) triggerWin('green'); else if(c.b===LUMIES_N) triggerWin('blue');}
function triggerWin(c){
  gameOver=true; winColor=c; if(ball){ball.active=false; ball.vx=ball.vy=0;}
  spawnConfetti(220,c);
}
function spawnConfetti(n,c){
  confetti.length=0;
  const cx=canvas.width/2, cy=canvas.height/2;
  const base=(c==='green')?COLOR_GREEN:COLOR_BLUE;
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, sp=3+Math.random()*5;
    const clr=(Math.random()<.15)?'#ffffff':base;
    confetti.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1,life:120+Math.random()*60,clr, size:2+Math.random()*3, rot:Math.random()*Math.PI});
  }
}
function stepConfetti(){
  for(let i=confetti.length-1;i>=0;i--){
    const p=confetti[i]; p.vy+=0.12; p.vx*=0.992; p.vy*=0.992; p.x+=p.vx; p.y+=p.vy; p.rot+=0.1; p.life--;
    if(p.life<=0) confetti.splice(i,1);
  }
}

/* ===== Physique ===== */
function step(){
  stepConfetti();

  // Balle jaune
  if (ball && ball.active) {
    // int√©gration + frottements
    ball.x += ball.vx; 
    ball.y += ball.vy; 
    ball.vx *= FRICTION; 
    ball.vy *= FRICTION; 
    ball.age += 16;

    // rebonds uniquement sur les c√¥t√©s
    if (ball.x < ball.r) {
      ball.x = ball.r;
      ball.vx = -ball.vx * RESTIT;
    }
    if (ball.x > canvas.width - ball.r) {
      ball.x = canvas.width - ball.r;
      ball.vx = -ball.vx * RESTIT;
    }

    // haut/bas = sortie de terrain -> fin de tour imm√©diate
    if (ball.y < ball.r || ball.y > canvas.height - ball.r) {
      ball.active = false;
      endOfTurn();
    } else {
      // collisions avec les lumies uniquement si la balle est toujours en jeu
      for (let i = 0; i < lumies.length; i++) {
        collideBallLumie(ball, lumies[i]);
      }

      // seuil d'arr√™t si elle s'immobilise sans sortir
      if (Math.abs(ball.vx) < STOP_EPS) ball.vx = 0;
      if (Math.abs(ball.vy) < STOP_EPS) ball.vy = 0;
      if (ball.vx === 0 && ball.vy === 0) {
        ball.active = false;
        endOfTurn();
      }
    }
  }

  // Lumies : frottements + murs
  for(let i=0;i<lumies.length;i++){
    const L=lumies[i];
    L.x+=L.vx; L.y+=L.vy; L.vx*=ROLL_F; L.vy*=ROLL_F;

    if(L.x<L.r){L.x=L.r;L.vx=-L.vx*RESTIT;}
    if(L.x>canvas.width-L.r){L.x=canvas.width-L.r;L.vx=-L.vx*RESTIT;}
    if(L.y<L.r){L.y=L.r;L.vy=-L.vy*RESTIT;}
    if(L.y>canvas.height-L.r){L.y=canvas.height-L.r;L.vy=-L.vy*RESTIT;}

    if(Math.abs(L.vx) < STOP_EPS) L.vx=0;
    if(Math.abs(L.vy) < STOP_EPS) L.vy=0;
  }

  // Collisions entre lumies
  for(let i=0;i<lumies.length;i++)
    for(let j=i+1;j<lumies.length;j++)
      collideLumies(lumies[i],lumies[j]);
}

function collideBallLumie(B,L){
  let dx=L.x-B.x, dy=L.y-B.y;
  let d=Math.hypot(dx,dy);
  const minD=B.r+L.r;

  if(d===0){ dx=1e-6; d=1e-6; }
  if(d>=minD) return;

  const nx=dx/d, ny=dy/d;
  const overlap=minD-d;

  // s√©paration
  B.x-=nx*overlap*0.5; B.y-=ny*overlap*0.5;
  L.x+=nx*overlap*0.5; L.y+=ny*overlap*0.5;

  // impulsion √©lastique (signe correct)
  const rvx=B.vx-L.vx, rvy=B.vy-L.vy;
  const vn = rvx*nx + rvy*ny;
  if(vn>0) return;

  const j=-(1+RESTIT)*vn/2;
  const jx=j*nx, jy=j*ny;
  B.vx -= jx; B.vy -= jy;
  L.vx += jx; L.vy += jy;

  tryToggleOnMoveFromImpact(L, Math.abs(vn));
}

function collideLumies(A,B){
  let dx=B.x-A.x, dy=B.y-A.y;
  let d=Math.hypot(dx,dy);
  const minD=A.r+B.r;

  if(d===0){ dx=1e-6; d=1e-6; }
  if(d>=minD) return;

  const nx=dx/d, ny=dy/d;
  const overlap=minD-d;

  A.x-=nx*overlap*0.5; A.y-=ny*overlap*0.5;
  B.x+=nx*overlap*0.5; B.y+=ny*overlap*0.5;

  const rvx=A.vx-B.vx, rvy=A.vy-B.vy;
  const vn=rvx*nx + rvy*ny;
  if(vn>0) return;

  const j=-(1+RESTIT)*vn/2;
  const jx=j*nx, jy=j*ny;
  A.vx -= jx; A.vy -= jy;
  B.vx += jx; B.vy += jy;

  tryToggleOnMoveFromImpact(A, Math.abs(vn));
  tryToggleOnMoveFromImpact(B, Math.abs(vn));

  // anti-collage √† l'arr√™t
  if (Math.hypot(A.vx,B.vx) + Math.hypot(A.vy,B.vy) < 0.02){
    const eps = 0.5;
    A.x -= nx*eps; A.y -= ny*eps;
    B.x += nx*eps; B.y += ny*eps;
    A.vx*=0.9; A.vy*=0.9; B.vx*=0.9; B.vy*=0.9;
  }
}

/* ===== Tours + Narration ===== */
function teamLabel(playerIdx){
  if(!playerColors[1]) return "Le joueur "+playerIdx;
  return "L‚Äô√©quipe " + (playerColors[playerIdx]==='green' ? "verte" : "bleue");
}

function buildNarration(prevPlayer, willReplay, changes){
  if(changes.length===0){
    return teamLabel(prevPlayer)+" a jou√©. Aucune Lumie n‚Äôa chang√©. " + (willReplay?"Elle rejoue.":"Elle ne rejoue pas.");
  }
  const toG = changes.filter(c=>c.after==='green').length;
  const toB = changes.filter(c=>c.after==='blue').length;
  const fromRed = changes.filter(c=>c.before==='red');

  const parts=[];
  if(changes.length===1){
    const c=changes[0];
    if(c.before==='red'){
      parts.push("une Lumie rouge qui est devenue al√©atoirement "+(c.after==='green'?"verte":"bleue"));
    }else{
      parts.push("une Lumie "+(c.before==='green'?"verte":"bleue")+" qui est devenue "+(c.after==='green'?"verte":"bleue"));
    }
  }else{
    // plusieurs
    if(toG && toB) parts.push("plusieurs Lumies qui sont devenues vertes et bleues");
    else if(toG)   parts.push("plusieurs Lumies qui sont devenues vertes");
    else if(toB)   parts.push("plusieurs Lumies qui sont devenues bleues");
  }

  return teamLabel(prevPlayer)+" a lanc√© le Luminator sur "+parts.join(", ")+". " + (willReplay?"Elle rejoue.":"Elle ne rejoue pas.");
}

function endOfTurn(){
  // narration bas√©e sur l‚Äô√©tat AVANT changement de joueur
  const prevPlayer = currentPlayer;
  const willReplay = (!playerColors[1]) ? false : (gainedThisTurn>0 && lostThisTurn===0);
  narrText.textContent = buildNarration(prevPlayer, willReplay, turnChanges);
  turnChanges.length=0;

  if(!playerColors[1]){ // tant que couleurs non fix√©es, alternance simple
    currentPlayer = (currentPlayer===1)?2:1;
    repositionBall(); updateBadge(); return;
  }
  if(willReplay){
    // rejoue (on garde currentPlayer)
  }else{
    currentPlayer = (currentPlayer===1)?2:1;
  }
  gainedThisTurn=0; lostThisTurn=0;
  repositionBall(); updateBadge();
}
function repositionBall(){
  const midX=canvas.width*0.5;
  const launchOffset=Math.max(56, canvas.height*0.14);
  if(currentPlayer===1){ ball.x=midX; ball.y=canvas.height-launchOffset; }
  else { ball.x=midX; ball.y=launchOffset; }
  ball.vx=0; ball.vy=0; ball.active=false;
}

/* ===== Rendu ===== */
function drawDashed(x1,y1,x2,y2,seg,space){
  let dx=x2-x1, dy=y2-y1, len=Math.hypot(dx,dy); if(len===0) return;
  // clamp visuel de la fl√®che
  const maxLen = MAX_AIM_LEN;
  if(len>maxLen){ const sc=maxLen/len; dx*=sc; dy*=sc; len=maxLen; x2=x1+dx; y2=y1+dy; }
  const nx=dx/len, ny=dy/len; let d=0, on=true, cx=x1, cy=y1;
  while(d<len){ let step=(on?seg:space); if(d+step>len) step=len-d; const sx=nx*step, sy=ny*step;
    if(on){ ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+sx,cy+sy); ctx.stroke(); }
    cx+=sx; cy+=sy; d+=step; on=!on;
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Fond
  if(mode==="night"){
    const g=ctx.createRadialGradient(canvas.width*.5,canvas.height*.5,10,canvas.width*.5,canvas.height*.5,Math.max(canvas.width,canvas.height)*.8);
    g.addColorStop(0,'#16224a'); g.addColorStop(1,'#0b1020'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  } else {
    const g2=ctx.createLinearGradient(0,0,0,canvas.height);
    g2.addColorStop(0,'#6abf69'); g2.addColorStop(1,'#2e7d32'); ctx.fillStyle=g2; ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // bases (semi-cercle haut et bas)
  const rBase=Math.min(canvas.width,canvas.height)*0.10;
  ctx.beginPath(); ctx.arc(canvas.width*.5,56, rBase, Math.PI, 0, false); ctx.fillStyle='rgba(255,255,255,0.18)'; ctx.fill();
  ctx.beginPath(); ctx.arc(canvas.width*.5,canvas.height, rBase, 0, Math.PI, false); ctx.fillStyle='rgba(255,255,255,0.18)'; ctx.fill();

  // ligne m√©diane
  ctx.strokeStyle='rgba(255,255,255,0.35)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(canvas.width*.06, canvas.height*.5); ctx.lineTo(canvas.width*.94, canvas.height*.5); ctx.stroke();

  // lumies
  for(let i=0;i<lumies.length;i++){
    const L=lumies[i];
    ctx.beginPath(); ctx.arc(L.x,L.y,L.r*1.5,0,Math.PI*2); ctx.fillStyle='rgba(255,90,103,0.20)'; ctx.fill();
    const fill=(L.color==='red')?COLOR_RED:(L.color==='green'?COLOR_GREEN:COLOR_BLUE);
    ctx.beginPath(); ctx.arc(L.x,L.y,L.r,0,Math.PI*2); ctx.fillStyle=fill; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.stroke();
  }

  // luminator
  if(ball){
    ctx.beginPath(); ctx.arc(ball.x,ball.y,R_BALL,0,Math.PI*2); ctx.fillStyle=COLOR_GOLD; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,0.75)'; ctx.stroke();
  }

  // fl√®che de vis√©e
  if(drag){
    ctx.strokeStyle='rgba(255,255,255,0.55)'; ctx.lineWidth=2;
    drawDashed(drag.sx,drag.sy,drag.x,drag.y,6,6);
    const vx=drag.x-drag.sx, vy=drag.y-drag.sy, ang=Math.atan2(vy,vx);
    const ax=drag.x, ay=drag.y, l=12;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(ax - l*Math.cos(ang - Math.PI/6), ay - l*Math.sin(ang - Math.PI/6));
    ctx.moveTo(ax, ay);
    ctx.lineTo(ax - l*Math.cos(ang + Math.PI/6), ay - l*Math.sin(ang + Math.PI/6));
    ctx.stroke();
  }

  // confettis
  for(let i=0;i<confetti.length;i++){
    const p=confetti[i]; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
    ctx.fillStyle=p.clr; ctx.fillRect(-p.size*0.5,-p.size*0.5,p.size,p.size); ctx.restore();
  }

  // overlay victoire
  if(gameOver){
    const cx=canvas.width/2, cy=canvas.height/2, R=Math.min(canvas.width,canvas.height)*0.30;
    ctx.fillStyle='#ffffff'; ctx.beginPath();
    const spikes=14; for(let k=0;k<spikes;k++){const a=(k/spikes)*Math.PI*2, r=(k%2?R*0.55:R), x=cx+Math.cos(a)*r, y=cy+Math.sin(a)*r; (k?ctx.lineTo(x,y):ctx.moveTo(x,y));}
    ctx.closePath(); ctx.fill();
    ctx.font=Math.floor(R*0.45)+'px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle=(winColor==='green')?COLOR_GREEN:COLOR_BLUE; ctx.fillText('LUMIOS',cx,cy);
  }
}

/* ===== Timer + boucle ===== */
setInterval(function(){
  const sTot=Math.floor((Date.now()-tStart)/1000);
  const m=Math.floor(sTot/60), s=sTot%60;
  hudClock.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
},1000);

function loop(){ step(); draw(); requestAnimationFrame(loop); }

/* Start */
sizeCanvas(); resetGame(); loop();
</script>
</body>
</html>
