<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lumios ‚Äì web proto</title>
<style>
  :root{
    --bg:#0b1020;
    --panel:#131a3a;
    --brand:#e65a6a;
    --green:#38d67a;
    --blue:#4da6ff;
    --red:#ff5a67;
    --gold:#ffd24a;
    --text:#fff;
    --hudH:56px;           /* hauteur du HUD */
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;height:100%;}
  /* Emp√™che le double-tap zoom sur mobile */
  * { touch-action: manipulation; }

  /* HUD en haut (toujours visible) */
  #hud{
    position:fixed; inset:0 0 auto 0; height:var(--hudH);
    padding:8px calc(12px + env(safe-area-inset-right)) 8px calc(12px + env(safe-area-inset-left));
    display:flex; align-items:center; gap:12px;
    background:rgba(5,10,25,.65); backdrop-filter:blur(8px);
    z-index:50;
  }

  /* timer + libell√© puissance + jauge + % align√©s √† gauche */
  #clock{ font-weight:700; letter-spacing:.5px; }
  #powerRow{ display:flex; align-items:center; gap:0px; margin-left:12px; } /* conserv√© */
  #powerTrack{ width:100px; height:10px; background:#121836; border-radius:999px; overflow:hidden } /* conserv√© */
  #powerFill{ height:100%; width:0%; background:#4da6ff; } /* conserv√© */

  /* IDs r√©els */
  #labelPow{ margin-left:8px; opacity:.85; }
  #powWrap{ width:140px; height:10px; background:#121836; border-radius:999px; overflow:hidden; margin:0 8px; }
  #powBar{ height:100%; width:0%; background:#4da6ff; }
  #powPct{ font-weight:700; }

  /* Badge du joueur */
  #badge{
    margin-left:auto;
    max-width:45vw;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-weight:800; font-size:16px;
    padding:8px 12px; border-radius:10px;
    color:#000; background:#6ab7ff;
    border:2px solid rgba(255,255,255,.15);
  }

  /* Zone de jeu (canvas sous HUD) */
  #wrap{ position:relative; width:100vw; height:100vh; }
  #canvas{
    position:absolute; inset:56px 0 0 0;   /* sous le HUD */
    display:block; width:100%; height:calc(100% - 56px);
    touch-action: pan-y;                   /* autorise le scroll vertical */
  }

  /* Panneau d‚Äôactions */
  #panel{
    width:140px;
    position:fixed; left:12px; top:50%; transform:translateY(-50%);
    z-index:5;
  }
  .card{background:var(--panel);border-radius:10px;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,.25);margin-bottom:8px}
  #brand {
  display:block;
  background:var(--brand);
  color:#fff;
  font-weight:bold;
  font-size:20px;
  letter-spacing:2px;
  text-align:center;
  border-radius:10px;
  text-decoration:none;   /* pas de soulignement */
  }
  .row{display:flex;justify-content:space-between;align-items:center;font-size:14px}
  .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
  .g{background:var(--green)} .b{background:var(--blue)}
  .btn{display:block;width:100%;margin-top:6px;padding:10px 12px;border-radius:8px;text-align:center;font-weight:bold;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.25);border:none}
  #btnMode{background:var(--green);color:#000}
  #btnNext{background:#ffb74a;color:#000}
  #btnReplay{background:var(--blue);color:#fff}
  #btnBuy{display:block;width:100%;margin-top:6px;padding:12px;border-radius:10px;text-align:center;font-weight:700;background:#ff4d6d;color:#fff;text-decoration:none;box-shadow:0 6px 16px rgba(0,0,0,.25)}
  #btnBuy:hover{filter:brightness(1.08)}

  /* le select a le look .btn aussi */
  #modeSelect.btn {
    -webkit-appearance:none; appearance:none;
    background:#222a56; color:#fff;
    font-weight:700;
  }

  /* Mobile : panel sous le canvas (scroll) */
  @media (max-width: 768px){
    #panel{
      position:static; transform:none; width:100%; max-width:420px;
      margin:18px auto; padding:0 12px;
    }
    #wrap{height:auto; min-height:100vh;}
    #canvas{position:relative; inset:auto; width:100%; height:calc(100vh - 56px);}
    /* badge plus compact si besoin */
    #badge{ font-size:14px; padding:6px 10px; border-radius:8px; max-width:54vw; }
  }
</style>
</head>
<body>

<!-- HUD -->
<div id="hud">
  <div id="clock">00:00</div>
  <div id="labelPow">Power</div>
  <div id="powWrap"><div id="powBar"></div></div>
  <div id="powPct">0%</div>
  <div id="badge">JOUEUR 1</div>
</div>

<!-- Zone de jeu -->
<div id="wrap">
  <canvas id="canvas"></canvas>
</div>

<!-- Panneau (desktop √† gauche, mobile en dessous apr√®s scroll) -->
<div id="panel">
  <a id="brand" class="card" href="https://www.lumios-le-jeu.fr/pages/regles-du-jeu-lumios" target="_blank" rel="noopener">R√®gles</a>

  <div class="card">
    <div class="row"><span><span class="dot g"></span>Verts</span><b id="cntG">0</b></div>
    <div class="row"><span><span class="dot b"></span>Bleus</span><b id="cntB">0</b></div>
  </div>

  <!-- ‚¨áÔ∏è Nouveau : choix mode -->
  <select id="modeSelect" class="btn">
    <option value="pvp">2 Joueurs</option>
    <option value="easy">Solo vs Robot (Facile)</option>
    <option value="hard">Solo vs Robot (Difficile)</option>
  </select>

  <button id="btnMode" class="btn">üåô Nuit</button>
  <button id="btnNext" class="btn">‚è≠Ô∏è Skip</button>
  <button id="btnReplay" class="btn">üîÑ Rejouer</button>
  <a id="btnBuy" href="https://www.lumios-le-jeu.fr/" target="_blank" rel="noopener">üéÅ Pr√©commander un vrai Jeu Lumios pour No√´l</a>
</div>

<script>
/* ===== Polyfill rAF ===== */
(function(){
  var v=['ms','moz','webkit','o'],i;
  for(i=0;i<v.length && !window.requestAnimationFrame;i++){
    window.requestAnimationFrame=window[v[i]+'RequestAnimationFrame'];
    window.cancelAnimationFrame=window[v[i]+'CancelAnimationFrame']||window[v[i]+'CancelRequestAnimationFrame'];
  }
  if(!window.requestAnimationFrame){
    window.requestAnimationFrame=function(cb){return setTimeout(function(){cb(Date.now());},16);};
    window.cancelAnimationFrame=function(id){clearTimeout(id);};
  }
})();

/* ===== Canvas ===== */
const canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d');
const hudClock=document.getElementById('clock');
const powBar=document.getElementById('powBar');
const powPct=document.getElementById('powPct');
const badge=document.getElementById('badge');
const elCntG=document.getElementById('cntG'), elCntB=document.getElementById('cntB');

function sizeCanvas(){
  const r=canvas.getBoundingClientRect();
  canvas.width = Math.max(1, Math.floor(r.width));
  canvas.height= Math.max(1, Math.floor(r.height));
  layout();
}
window.addEventListener('resize', sizeCanvas);

/* ===== Couleurs ===== */
const COLOR_RED   ='#ff5a67';
const COLOR_GREEN ='#38d67a';
const COLOR_BLUE  ='#4da6ff';
const COLOR_GOLD  = '#ffd24a';   // ‚Üê AJOUT

/* ===== Param√®tres ===== */
const LUMIES_N=5, R_LUMIE=22, R_BALL=16;
const LUMIE_SPACING = R_LUMIE * 4;
const RESTIT=0.95, FRICTION=0.992, ROLL_F=0.996;
const POWER_K=0.09, MAX_DRAG=320;
const MAX_AIM_LEN = 120;           // longueur max de la fl√®che de vis√©e
const BASE_ZONE_RATIO=0.16;        // zone de lancement

// D√©tections robustes
const MOVE_EPS = 0.000;
const COLOR_COOLDOWN = 4000;        // ms

/* ===== √âtat ===== */
let lumies=[], ball=null, drag=null, tStart=Date.now();
let mode="night";                         // "night" ou "day"
let currentPlayer=1;
let playerColors={1:null,2:null};
let gainedThisTurn=0, lostThisTurn=0;
let gameOver=false, winColor=null, confetti=[];
let showHint = true;


/* ‚¨áÔ∏è Nouveau : mode de jeu */
let gameMode = "pvp"; // "pvp" | "easy" | "hard"
const modeSelect = document.getElementById('modeSelect');
modeSelect.onchange = function(){
  gameMode = this.value;
  resetGame();           // on red√©marre proprement avec ce mode
};

/* ===== UI ===== */
const btnMode=document.getElementById('btnMode');
btnMode.onclick=function(){
  if(mode==="night"){ mode="day"; btnMode.textContent="‚òÄÔ∏è Jour"; btnMode.style.background=COLOR_BLUE; btnMode.style.color="#fff"; }
  else { mode="night"; btnMode.textContent="üåô Nuit"; btnMode.style.background=COLOR_GREEN; btnMode.style.color="#000"; }
};
document.getElementById('btnNext').onclick=function(){
  if(ball){ ball.active=false; ball.vx=0; ball.vy=0; }
  endOfTurn();
};
document.getElementById('btnReplay').onclick=function(){
  resetGame();
};

function countColors(){let g=0,b=0;for(let i=0;i<lumies.length;i++){const c=lumies[i].color; if(c==='green')g++; else if(c==='blue')b++;}return {g,b};}
function updateScore(){const c=countColors(); elCntG.textContent=c.g; elCntB.textContent=c.b;}

/* ===== Init ===== */
function resetGame(){
  playerColors={1:null,2:null};
  currentPlayer=1;
  gainedThisTurn=0; lostThisTurn=0;
  gameOver=false; winColor=null; confetti.length=0;
  tStart=Date.now();
  layout();
}

function layout(){
  lumies=[];
  const midX=canvas.width*0.5;
  const midY=canvas.height*0.5;

  // Spacing responsive
  let spacing=LUMIE_SPACING, startX=midX - spacing*(LUMIES_N-1)/2;
  const isMobile=(canvas.width<=768) || (window.innerHeight>window.innerWidth);
  if(isMobile){
    const marginX=Math.max(16, canvas.width*0.06);
    const usable = canvas.width - 2*(marginX + R_LUMIE);
    const fitSpacing = (LUMIES_N>1)? (usable/(LUMIES_N-1)) : 0;
    spacing = Math.min(LUMIE_SPACING, fitSpacing);
    const rowW = spacing*(LUMIES_N-1);
    startX = Math.max(marginX + R_LUMIE, midX - rowW/2);
  }

  for(let i=0;i<LUMIES_N;i++){
    const x=startX + i*spacing;
    lumies.push({x, y:midY, vx:0, vy:0, r:R_LUMIE, color:'red', lastHit:0});
  }

  const launchOffset = Math.max(56, canvas.height*0.14);
  if(currentPlayer===1){
    ball={x:midX, y:canvas.height-launchOffset, vx:0, vy:0, r:R_BALL, active:false, age:0};
  }else{
    ball={x:midX, y:launchOffset, vx:0, vy:0, r:R_BALL, active:false, age:0};
  }

  gainedThisTurn=0; lostThisTurn=0;
  updateScore();
  updateBadge();
}

function updateBadge(){
  if(!playerColors[1]){
    badge.style.background = COLOR_BLUE;
    badge.textContent = "JOUEUR "+currentPlayer;
    return;
  }
  const meCol = playerColors[currentPlayer];
  badge.style.background = (meCol==='green')?COLOR_GREEN:COLOR_BLUE;
  badge.textContent = "JOUEUR "+currentPlayer+" - "+meCol.toUpperCase();
}

/* ===== Entr√©es ===== */
function getPos(e){const r=canvas.getBoundingClientRect(); let x,y;
  if(e.touches&&e.touches.length){x=e.touches[0].clientX-r.left;y=e.touches[0].clientY-r.top;}
  else{x=e.clientX-r.left;y=e.clientY-r.top;} return {x,y};}

function inBaseZone(y){
  const zone=canvas.height*BASE_ZONE_RATIO;
  return currentPlayer===1 ? (y>canvas.height-zone) : (y<zone);
}

canvas.addEventListener('mousedown',startDrag,{passive:false});
canvas.addEventListener('touchstart',startDrag,{passive:false});
function startDrag(e){
  if(gameOver) return;

  // ‚¨áÔ∏è Si mode Solo et c'est au robot (joueur 2), on ignore l'entr√©e utilisateur
  if(gameMode!=='pvp' && currentPlayer===2) return;

  const p=getPos(e);
  if(!inBaseZone(p.y)) return;   // ne pas bloquer le scroll si hors zone de tir
  e.preventDefault();            // on d√©marre un tir : bloque le scroll
  drag={sx:p.x,sy:p.y,x:p.x,y:p.y};
}

canvas.addEventListener('mousemove',moveDrag,{passive:false});
canvas.addEventListener('touchmove',moveDrag,{passive:false});
function moveDrag(e){
  if(!drag) return;
  const p=getPos(e); drag.x=p.x; drag.y=p.y; updatePowerUI(drag);
}

canvas.addEventListener('mouseup',endDrag); canvas.addEventListener('mouseleave',endDrag);
canvas.addEventListener('touchend',endDrag);
function endDrag(e){
  if(!drag) return;
  let vx=drag.x-drag.sx, vy=drag.y-drag.sy, len=Math.hypot(vx,vy);
  if(len>5){
    const p=Math.min(len,MAX_DRAG);
    const ux=vx/len, uy=vy/len;
    const speed=p*POWER_K;
    ball.x=drag.sx; ball.y=drag.sy;
    ball.vx=ux*speed; ball.vy=uy*speed;
    ball.active=true; ball.age=0;
    showHint = false;   // üîπ plus de message apr√®s 1er tir
  }
  drag=null; updatePowerUI(null);
}


function updatePowerUI(d){
  if(!d){ powPct.textContent='0%'; powBar.style.width='0%'; powBar.style.background=COLOR_BLUE; return; }
  let vx=d.x-d.sx, vy=d.y-d.sy, len=Math.hypot(vx,vy), p=Math.min(len,MAX_DRAG);
  const pct=Math.round((p/MAX_DRAG)*100);
  powPct.textContent=pct+'%'; powBar.style.width=pct+'%';
  powBar.style.background = pct<40?COLOR_BLUE:(pct<75?COLOR_GREEN:'#ffb74a');
}

/* ===== R√®gle couleurs ===== */
function onLumieHit(L){
  const before=L.color;
  if(before==='red'){
    L.color = (Math.random()<0.5)?'green':'blue';
    // premi√®re attribution des √©quipes
    if(!playerColors[1] && !playerColors[2]){
      playerColors[currentPlayer]=L.color;
      playerColors[(currentPlayer===1)?2:1] = (L.color==='green')?'blue':'green';
      updateBadge();
    }
  }else if(before==='green'){
    L.color='blue';
  }else if(before==='blue'){
    L.color='green';
  }
  // scoring & victoire
  updateScore();
  checkWin();

  // suivi des gains/pertes si √©quipes d√©j√† fix√©es
  if(playerColors[1]){
    if(L.color===playerColors[currentPlayer] && before!==playerColors[currentPlayer]) gainedThisTurn++;
    if(before===playerColors[currentPlayer] && L.color!==playerColors[currentPlayer]) lostThisTurn++;
  }
}

// Anti-spam & ‚Äúbouge ‚Üí change‚Äù
function tryToggleOnMove(L){
  const now=performance.now();
  if(!L.lastHit) L.lastHit=0;
  if(now-L.lastHit < COLOR_COOLDOWN) return;
  if(Math.hypot(L.vx,L.vy) < MOVE_EPS) return;
  onLumieHit(L);
  L.lastHit = now;
}

/* ===== Victoire ===== */
function checkWin(){const c=countColors(); if(c.g===LUMIES_N) triggerWin('green'); else if(c.b===LUMIES_N) triggerWin('blue');}
function triggerWin(c){
  gameOver=true; winColor=c; if(ball){ball.active=false; ball.vx=ball.vy=0;}
  spawnConfetti(220,c);
}
function spawnConfetti(n,c){
  confetti.length=0;
  const cx=canvas.width/2, cy=canvas.height/2;
  const base=(c==='green')?COLOR_GREEN:COLOR_BLUE;
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, sp=3+Math.random()*5;
    const clr=(Math.random()<.15)?'#ffffff':base;
    confetti.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1,life:120+Math.random()*60,clr, size:2+Math.random()*3, rot:Math.random()*Math.PI});
  }
}
function stepConfetti(){
  for(let i=confetti.length-1;i>=0;i--){
    const p=confetti[i]; p.vy+=0.12; p.vx*=0.992; p.vy*=0.992; p.x+=p.vx; p.y+=p.vy; p.rot+=0.1; p.life--;
    if(p.life<=0) confetti.splice(i,1);
  }
}

/* ===== Physique ===== */
function step(){
  stepConfetti();

  // Balle jaune
  if(ball && ball.active){
    ball.x+=ball.vx; ball.y+=ball.vy; ball.vx*=FRICTION; ball.vy*=FRICTION; ball.age+=16;
    if(ball.x<ball.r){ball.x=ball.r;ball.vx=-ball.vx*RESTIT;}
    if(ball.x>canvas.width-ball.r){ball.x=canvas.width-ball.r;ball.vx=-ball.vx*RESTIT;}
    if(ball.y<ball.r){ball.y=ball.r;ball.vy=-ball.vy*RESTIT;}
    if(ball.y>canvas.height-ball.r){ball.y=canvas.height-ball.r;ball.vy=-ball.vy*RESTIT;}

    for(let i=0;i<lumies.length;i++) collideBallLumie(ball, lumies[i]);

    if(Math.abs(ball.vx)<0.05 && Math.abs(ball.vy)<0.05){ ball.active=false; endOfTurn(); }
  }

  // Lumies : frottements + murs + toggle on move
  for(let i=0;i<lumies.length;i++){
    const L=lumies[i];
    let hitWall=false;
    L.x+=L.vx; L.y+=L.vy; L.vx*=ROLL_F; L.vy*=ROLL_F;

    if(L.x<L.r){L.x=L.r;L.vx=-L.vx*RESTIT;hitWall=true;}
    if(L.x>canvas.width-L.r){L.x=canvas.width-L.r;L.vx=-L.vx*RESTIT;hitWall=true;}
    if(L.y<L.r){L.y=L.r;L.vy=-L.vy*RESTIT;hitWall=true;}
    if(L.y>canvas.height-L.r){L.y=canvas.height-L.r;L.vy=-L.vy*RESTIT;hitWall=true;}
    if(hitWall) tryToggleOnMove(L);
  }

  // Collisions entre lumies
  for(let i=0;i<lumies.length;i++)
    for(let j=i+1;j<lumies.length;j++)
      collideLumies(lumies[i],lumies[j]);
}

function collideBallLumie(B,L){
  let dx=L.x-B.x, dy=L.y-B.y;
  let d=Math.hypot(dx,dy);
  const minD=B.r+L.r;

  if(d===0){ dx=1e-6; d=1e-6; }
  if(d>=minD) return;

  const nx=dx/d, ny=dy/d;
  const overlap=minD-d;

  // S√©paration g√©om√©trique (petit push-out)
  B.x-=nx*overlap*0.5; B.y-=ny*overlap*0.5;
  L.x+=nx*overlap*0.5; L.y+=ny*overlap*0.5;

  // Vitesse relative sur la normale
  const rvx=B.vx-L.vx, rvy=B.vy-L.vy;
  const vn = rvx*nx + rvy*ny;

  // ‚ö†Ô∏è M√™me en s√©paration (vn>0), on consid√®re qu'il y a eu contact -> toggle possible
  if (vn > 0){
    tryToggleOnMove(L);
    return;
  }

  // Impulsion √©lastique (masses √©gales)
  const j=-(1+RESTIT)*vn/2;
  const jx=j*nx, jy=j*ny;
  B.vx -= jx; B.vy -= jy;
  L.vx += jx; L.vy += jy;

  // Changement couleur d√©clench√© par le mouvement
  tryToggleOnMove(L);
}

function collideLumies(A,B){
  let dx=B.x-A.x, dy=B.y-A.y;
  let d=Math.hypot(dx,dy);
  const minD=A.r+B.r;

  if(d===0){ dx=1e-6; d=1e-6; }
  if(d>=minD) return;

  const nx=dx/d, ny=dy/d;
  const overlap=minD-d;

  // S√©paration
  A.x-=nx*overlap*0.5; A.y-=ny*overlap*0.5;
  B.x+=nx*overlap*0.5; B.y+=ny*overlap*0.5;

  const rvx=A.vx-B.vx, rvy=A.vy-B.vy;
  const vn=rvx*nx + rvy*ny;

  if (vn > 0){
    // M√™me logique : contact r√©el, on autorise le toggle
    tryToggleOnMove(A);
    tryToggleOnMove(B);
    return;
  }

  const j=-(1+RESTIT)*vn/2;
  const jx=j*nx, jy=j*ny;
  A.vx -= jx; A.vy -= jy;
  B.vx += jx; B.vy += jy;

  tryToggleOnMove(A);
  tryToggleOnMove(B);
}



/* ===== Tours ===== */
function endOfTurn(){
  if(!playerColors[1]){ // tant que couleurs non fix√©es, alternance simple
    currentPlayer = (currentPlayer===1)?2:1;
    repositionBall(); updateBadge();

    // ‚¨áÔ∏è Si mode Solo et c'est au robot, jouer automatiquement
    if(gameMode!=='pvp' && currentPlayer===2 && !gameOver){
      setTimeout(robotPlay, 800);
    }
    return;
  }

  if(gainedThisTurn>0 && lostThisTurn===0){
    // rejoue (on garde currentPlayer)
  }else{
    currentPlayer = (currentPlayer===1)?2:1;
  }
  gainedThisTurn=0; lostThisTurn=0;
  repositionBall(); updateBadge();

  // ‚¨áÔ∏è mode Solo : robot joue quand c'est √† lui
  if(gameMode!=='pvp' && currentPlayer===2 && !gameOver){
    setTimeout(robotPlay, 800);
  }
}

function repositionBall(){
  const midX=canvas.width*0.5;
  const launchOffset=Math.max(56, canvas.height*0.14);
  if(currentPlayer===1){ ball.x=midX; ball.y=canvas.height-launchOffset; }
  else { ball.x=midX; ball.y=launchOffset; }
  ball.vx=0; ball.vy=0; ball.active=false;
}

/* ‚¨áÔ∏è Nouveau : IA joueur 2 */
function robotPlay(){
  if(gameOver) return;

  // Choix d'une cible
  let target = null;

  if(gameMode === 'easy' || !playerColors[1]){
    // Facile : cible au hasard
    target = lumies[Math.floor(Math.random()*lumies.length)];
  } else {
    // Difficile : privil√©gier une boule qui n'est pas d√©j√† √† sa couleur
    const myCol = playerColors[2]; // couleur du robot
    const candidates = lumies.filter(l => l.color !== myCol);
    target = (candidates.length? candidates[Math.floor(Math.random()*candidates.length)]
                               : lumies[Math.floor(Math.random()*lumies.length)]);
  }

  // Direction depuis la base du joueur 2 (la balle y est d√©j√† repositionn√©e)
  const dx = target.x - ball.x;
  const dy = target.y - ball.y;
  const len = Math.hypot(dx,dy) || 1;
  const ux = dx/len, uy = dy/len;

  // Puissance selon mode
  let power;
  if(gameMode === 'easy'){
    power = 0.45 + Math.random()*0.25; // 45% √† 70%
  } else if (gameMode === 'hard'){
    power = 0.65 + Math.random()*0.25; // 65% √† 90%
  } else {
    power = 0.6;
  }
  const speed = MAX_DRAG * POWER_K * power;

  ball.vx = ux * speed;
  ball.vy = uy * speed;
  ball.active = true;
  ball.age = 0;
}

/* ===== Rendu ===== */
function drawDashed(x1,y1,x2,y2,seg,space){
  let dx=x2-x1, dy=y2-y1, len=Math.hypot(dx,dy); if(len===0) return;
  // clamp visuel de la fl√®che
  const maxLen = MAX_AIM_LEN;
  if(len>maxLen){ const sc=maxLen/len; dx*=sc; dy*=sc; len=maxLen; x2=x1+dx; y2=y1+dy; }
  const nx=dx/len, ny=dy/len; let d=0, on=true, cx=x1, cy=y1;
  while(d<len){ let step=(on?seg:space); if(d+step>len) step=len-d; const sx=nx*step, sy=ny*step;
    if(on){ ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+sx,cy+sy); ctx.stroke(); }
    cx+=sx; cy+=sy; d+=step; on=!on;
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Fond
  if(mode==="night"){
    const g=ctx.createRadialGradient(canvas.width*.5,canvas.height*.5,10,canvas.width*.5,canvas.height*.5,Math.max(canvas.width,canvas.height)*.8);
    g.addColorStop(0,'#16224a'); g.addColorStop(1,'#0b1020'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  } else {
    const g2=ctx.createLinearGradient(0,0,0,canvas.height);
    g2.addColorStop(0,'#6abf69'); g2.addColorStop(1,'#2e7d32'); ctx.fillStyle=g2; ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // bases (semi-cercle haut et bas)
  const rBase=Math.min(canvas.width,canvas.height)*0.10;
  ctx.beginPath(); ctx.arc(canvas.width*.5,56, rBase, Math.PI, 0, false); ctx.fillStyle='rgba(255,255,255,0.18)'; ctx.fill();
  ctx.beginPath(); ctx.arc(canvas.width*.5,canvas.height, rBase, 0, Math.PI, false); ctx.fillStyle='rgba(255,255,255,0.18)'; ctx.fill();

  // ligne m√©diane
  ctx.strokeStyle='rgba(255,255,255,0.35)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(canvas.width*.06, canvas.height*.5); ctx.lineTo(canvas.width*.94, canvas.height*.5); ctx.stroke();

  // lumies
  for(let i=0;i<lumies.length;i++){
    const L=lumies[i];
    ctx.beginPath(); ctx.arc(L.x,L.y,L.r*1.5,0,Math.PI*2); ctx.fillStyle='rgba(255,90,103,0.20)'; ctx.fill();
    const fill=(L.color==='red')?COLOR_RED:(L.color==='green'?COLOR_GREEN:COLOR_BLUE);
    ctx.beginPath(); ctx.arc(L.x,L.y,L.r,0,Math.PI*2); ctx.fillStyle=fill; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.stroke();
  }

  // luminator
if(ball){
  ctx.beginPath();
  ctx.arc(ball.x,ball.y,R_BALL,0,Math.PI*2);
  ctx.fillStyle=COLOR_GOLD;
  ctx.fill();
  ctx.lineWidth=3;
  ctx.strokeStyle='rgba(255,255,255,0.75)';
  ctx.stroke();

  // üîπ message de d√©part
  if(showHint){
    ctx.font="18px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="bottom";
    ctx.fillStyle="#fff";
    ctx.fillText("Lancez la balle en visant les boules", ball.x, ball.y - R_BALL - 20);
  }
  }


  // fl√®che de vis√©e
  if(drag){
    ctx.strokeStyle='rgba(255,255,255,0.55)'; ctx.lineWidth=2;
    drawDashed(drag.sx,drag.sy,drag.x,drag.y,6,6);
    const vx=drag.x-drag.sx, vy=drag.y-drag.sy, ang=Math.atan2(vy,vx);
    const ax=drag.x, ay=drag.y, l=12;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(ax - l*Math.cos(ang - Math.PI/6), ay - l*Math.sin(ang - Math.PI/6));
    ctx.moveTo(ax, ay);
    ctx.lineTo(ax - l*Math.cos(ang + Math.PI/6), ay - l*Math.sin(ang + Math.PI/6));
    ctx.stroke();
  }

  // confettis
  for(let i=0;i<confetti.length;i++){
    const p=confetti[i]; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
    ctx.fillStyle=p.clr; ctx.fillRect(-p.size*0.5,-p.size*0.5,p.size,p.size); ctx.restore();
  }

  // overlay victoire
  if(gameOver){
    const cx=canvas.width/2, cy=canvas.height/2, R=Math.min(canvas.width,canvas.height)*0.30;
    ctx.fillStyle='#ffffff'; ctx.beginPath();
    const spikes=14; for(let k=0;k<spikes;k++){const a=(k/spikes)*Math.PI*2, r=(k%2?R*0.55:R), x=cx+Math.cos(a)*r, y=cy+Math.sin(a)*r; (k?ctx.lineTo(x,y):ctx.moveTo(x,y));}
    ctx.closePath(); ctx.fill();
    ctx.font=Math.floor(R*0.45)+'px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle=(winColor==='green')?COLOR_GREEN:COLOR_BLUE; ctx.fillText('LUMIOS',cx,cy);
  }
}

/* ===== Timer + boucle ===== */
setInterval(function(){
  const sTot=Math.floor((Date.now()-tStart)/1000);
  const m=Math.floor(sTot/60), s=sTot%60;
  hudClock.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
},1000);

function loop(){ step(); draw(); requestAnimationFrame(loop); }

/* Start */
sizeCanvas(); resetGame(); loop();
</script>
</body>
</html>
