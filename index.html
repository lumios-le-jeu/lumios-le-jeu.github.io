<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Lumios ‚Äì mobile HUD + scroll</title>

<style>
  :root{ --hudH:56px; }

  html,body{
    margin:0; padding:0; height:100%; width:100%;
    background:#0b1020; color:#fff; font-family:Arial,Helvetica,sans-serif;
  }

  /* ===== HUD fix√© en haut (timer / puissance / badge joueur) ===== */
  #hud{
    position:fixed; inset:0 0 auto 0; height:var(--hudH);
    padding:8px calc(12px + env(safe-area-inset-right)) 8px calc(12px + env(safe-area-inset-left));
    display:flex; align-items:center; gap:12px;
    background:rgba(5,10,25,.65); backdrop-filter:blur(8px);
    z-index:50;
  }
  #clock{ font-weight:700; letter-spacing:.5px; }
  #powerRow{ display:flex; align-items:center; gap:10px; margin-left:12px; }
  #powerTrack{ width:140px; height:10px; background:#121836; border-radius:999px; overflow:hidden }
  #powerFill{ height:100%; width:0%; background:#4da6ff; }
  #powerPct{ font-weight:700; }

  #badge{
    margin-left:auto;
    max-width:45vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-weight:800; font-size:16px;
    padding:8px 12px; border-radius:10px;
    color:#001a33; background:#6ab7ff;
    border:2px solid rgba(255,255,255,.15);
  }

  @media (max-width:768px){
    #badge{ font-size:15px; padding:6px 10px; max-width:52vw; }
    #powerTrack{ width:110px; }
  }
  @media (max-width:380px){
    #badge{ font-size:14px; padding:6px 8px; max-width:58vw; }
    #powerTrack{ width:92px; }
  }

  /* ===== Zone de jeu ===== */
  #wrap{ min-height:100vh; padding-top:var(--hudH); }
  #canvas{
    display:block; width:100vw; height:calc(100vh - var(--hudH));
    touch-action: pan-y;           /* iOS: autorise scroll vertical par d√©faut */
    background:#0b1020;
  }

  /* ===== Panneau d‚Äôactions (sous le canvas) ===== */
  #panel{
    position:static; transform:none; width:100%; max-width:420px;
    margin:18px auto; padding:0 12px;
  }
  .card{
    background:#131a3a; border-radius:10px; padding:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.25); margin-bottom:8px;
  }
  #brand{ background:#e65a6a; color:#fff; font-weight:bold; font-size:20px;
          letter-spacing:2px; text-align:center; }
  .row{ display:flex; justify-content:space-between; align-items:center; font-size:14px }
  .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px }
  .g{ background:#38d67a } .b{ background:#4da6ff }

  #btnMode, #btnNext, #btnReplay, #btnBuy{
    display:block; width:100%;
    margin-top:6px; padding:10px 12px;
    border-radius:8px; text-align:center; font-weight:bold; cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.25); border:none;
  }
  #btnMode{ background:#38d67a; color:#000; }
  #btnNext{ background:#ffb74a; color:#000; }
  #btnReplay{ background:#4da6ff; color:#fff; }
  #btnBuy{ background:#ff4d6d; color:#fff; text-decoration:none; }

  /* Couleurs jeu */
  .hidden{ display:none; }
</style>
</head>

<body>
  <!-- HUD -->
  <div id="hud">
    <div id="clock">00:00</div>
    <div id="powerRow">
      <span>Puissance</span>
      <div id="powerTrack"><div id="powerFill"></div></div>
      <b id="powerPct">0%</b>
    </div>
    <div id="badge"><span id="badgeText">JOUEUR 1</span></div>
  </div>

  <!-- Terrain -->
  <div id="wrap">
    <canvas id="canvas"></canvas>
  </div>

  <!-- Panneau sous le terrain (visible en scroll) -->
  <div id="panel">
    <div id="brand" class="card">LUMIOS</div>

    <div class="card">
      <div class="row"><span><span class="dot g"></span>Verts</span><b id="cntG">0</b></div>
      <div class="row"><span><span class="dot b"></span>Bleus</span><b id="cntB">0</b></div>
    </div>

    <button id="btnMode">üåô Nuit</button>
    <button id="btnNext">‚è≠Ô∏è Skip</button>
    <button id="btnReplay">üîÑ Rejouer</button>
    <a id="btnBuy" href="https://www.lumios-le-jeu.fr/" target="_blank" rel="noopener">
      üéÅ Pr√©commander un vrai Jeu Lumios pour No√´l
    </a>
  </div>

<script>
/* ========= rAF polyfill ========= */
(function(){
  var v=['ms','moz','webkit','o'],i;
  for(i=0;i<v.length && !window.requestAnimationFrame;i++){
    window.requestAnimationFrame=window[v[i]+'RequestAnimationFrame'];
    window.cancelAnimationFrame=window[v[i]+'CancelAnimationFrame']||window[v[i]+'CancelRequestAnimationFrame'];
  }
  if(!window.requestAnimationFrame){
    window.requestAnimationFrame=function(cb){return setTimeout(function(){cb(Date.now());},16);};
    window.cancelAnimationFrame=function(id){clearTimeout(id);};
  }
})();

/* ========= Canvas ========= */
const canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d');
function resize(){ canvas.width=window.innerWidth; canvas.height=Math.max(200, window.innerHeight - document.getElementById('hud').offsetHeight); layout(); }
window.addEventListener('resize',resize);

/* ========= DOM refs ========= */
const elClock=document.getElementById('clock');
const elPowerPct=document.getElementById('powerPct');
const elPowerFill=document.getElementById('powerFill');
const elCntG=document.getElementById('cntG'), elCntB=document.getElementById('cntB');
const btnMode=document.getElementById('btnMode');
const btnNext=document.getElementById('btnNext');
const btnReplay=document.getElementById('btnReplay');
const elBadge=document.getElementById('badge'), elBadgeText=document.getElementById('badgeText');

/* ========= Constantes & √©tat ========= */
const COLOR_RED='#ff5a67', COLOR_GREEN='#38d67a', COLOR_BLUE='#4da6ff';
const LUMIES_N=5, R_LUMIE=22, R_BALL=16;
const LUMIE_SPACING=R_LUMIE*4;
const RESTIT=0.95, FRICTION=0.992, ROLL_F=0.996;
const POWER_K=0.09, MAX_DRAG=320, BASE_ZONE_RATIO=0.12;
const ARROW_MAX=120;                 // longueur max de la fl√®che (px)
const LOCK_MS=400;                   // verrou (ms) post-changement couleur

let mode='night';
let lumies=[], ball=null, drag=null, tStart=Date.now();
let currentPlayer=1;
let playerColors={1:null,2:null};
let gainedThisTurn=0, lostThisTurn=0;
let gameOver=false, winColor=null, confetti=[];

/* ========= Helpers ========= */
function countColors(){let g=0,b=0; for(const L of lumies){if(L.color==='green')g++; else if(L.color==='blue')b++;} return {g,b};}
function updateScore(){const c=countColors(); elCntG.textContent=c.g; elCntB.textContent=c.b;}
function now(){return performance.now();}

function renderBadge(){
  if(playerColors[1]){
    const col=playerColors[currentPlayer];
    elBadgeText.textContent=`JOUEUR ${currentPlayer} - ${col.toUpperCase()}`;
    elBadge.style.background=(col==='green')?COLOR_GREEN:COLOR_BLUE;
    elBadge.style.color =(col==='green')?'#08351f':'#001a33';
  }else{
    elBadgeText.textContent=`JOUEUR ${currentPlayer}`;
    elBadge.style.background='#6ab7ff'; elBadge.style.color='#001a33';
  }
}

/* ========= Init ========= */
function layout(){
  lumies=[];
  const midX=canvas.width*0.5, midY=canvas.height*0.5;

  // ligne centr√©e, spacing ajust√© si √©troit
  let spacing=LUMIE_SPACING;
  const marginX=Math.max(16, canvas.width*0.06);
  const usable=canvas.width-2*(marginX+R_LUMIE);
  if(LUMIES_N>1) spacing=Math.min(LUMIE_SPACING, usable/(LUMIES_N-1));
  const startX=midX - spacing*(LUMIES_N-1)/2;

  for(let i=0;i<LUMIES_N;i++){
    const x=startX + i*spacing;
    lumies.push({x, y:midY, vx:0, vy:0, r:R_LUMIE, color:'red', lockedUntil:0});
  }

  const launchY=canvas.height*0.10;
  ball={ x:midX, y:(currentPlayer===1?canvas.height-launchY:launchY),
         vx:0, vy:0, r:R_BALL, active:false, age:0 };

  gainedThisTurn=0; lostThisTurn=0;
  updateScore(); renderBadge();
}

/* ========= Entr√©es ========= */
function getPos(e){const r=canvas.getBoundingClientRect(); let x,y;
  if(e.touches&&e.touches.length){x=e.touches[0].clientX-r.left; y=e.touches[0].clientY-r.top;}
  else {x=e.clientX-r.left; y=e.clientY-r.top;}
  return {x,y};
}
function inBaseZone(y){
  const zone=canvas.height*BASE_ZONE_RATIO;
  return (currentPlayer===1)? (y>canvas.height-zone) : (y<zone);
}

canvas.addEventListener('mousedown',startDrag);
canvas.addEventListener('touchstart',startDrag,{passive:false});
function startDrag(e){
  if(gameOver) return;
  const p=getPos(e);
  if(!inBaseZone(p.y)) return;          // laisse scroller si on n'est pas en zone de tir
  e.preventDefault();                   // on commence un tir -> bloque le scroll
  canvas.style.touchAction='none';
  drag={sx:p.x, sy:p.y, x:p.x, y:p.y};
}

canvas.addEventListener('mousemove',moveDrag);
canvas.addEventListener('touchmove',moveDrag,{passive:false});
function moveDrag(e){
  if(!drag) return;
  const p=getPos(e); drag.x=p.x; drag.y=p.y; updatePowerUI(drag);
}

canvas.addEventListener('mouseup',endDrag);
canvas.addEventListener('mouseleave',endDrag);
canvas.addEventListener('touchend',endDrag);
function endDrag(e){
  if(!drag) return;
  const vx=drag.x-drag.sx, vy=drag.y-drag.sy, len=Math.hypot(vx,vy);
  if(len>5){
    const cap=Math.min(len, ARROW_MAX);
    const ux=vx/len,  uy=vy/len;
    const speed=cap*POWER_K;
    ball.x=drag.sx; ball.y=drag.sy;
    ball.vx=ux*speed; ball.vy=uy*speed;
    ball.active=true; ball.age=0;
  }
  drag=null; updatePowerUI(null);
  canvas.style.touchAction='pan-y';   // re-permet le scroll
}

function updatePowerUI(d){
  if(!d){ elPowerPct.textContent='0%'; elPowerFill.style.width='0%'; elPowerFill.style.background='#4da6ff'; return; }
  const vx=d.x-d.sx, vy=d.y-d.sy;
  const len=Math.hypot(vx,vy), p=Math.min(len, ARROW_MAX);
  const pct=Math.round((p/ARROW_MAX)*100);
  elPowerPct.textContent=pct+'%';
  elPowerFill.style.width=pct+'%';
  elPowerFill.style.background = pct<40 ? '#4da6ff' : (pct<75 ? '#38d67a' : '#ffb74a');
}

/* ========= Changement couleur ========= */
function onLumieHit(L){
  const t=now(); if(t < L.lockedUntil) return;     // verrou : ignore les chocs
  const before=L.color;
  if(before==='red'){
    L.color=(Math.random()<0.5)?'green':'blue';
    if(!playerColors[1] && !playerColors[2]){
      playerColors[currentPlayer]=L.color;
      playerColors[(currentPlayer===1)?2:1]=(L.color==='green'?'blue':'green');
      renderBadge();
    }
  }else if(before==='green'){ L.color='blue'; }
  else if(before==='blue'){  L.color='green'; }

  // suivi gains/pertes si √©quipes d√©finies
  if(playerColors[1]){
    if(L.color===playerColors[currentPlayer] && before!==playerColors[currentPlayer]) gainedThisTurn++;
    if(before===playerColors[currentPlayer] && L.color!==playerColors[currentPlayer]) lostThisTurn++;
  }

  L.lockedUntil = t + LOCK_MS; // 0.4 s de cooldown
  updateScore(); checkWin();
}

/* ========= Win & confettis ========= */
function checkWin(){const c=countColors(); if(c.g===LUMIES_N) triggerWin('green'); else if(c.b===LUMIES_N) triggerWin('blue');}
function triggerWin(c){
  gameOver=true; winColor=c; ball.active=false; ball.vx=ball.vy=0;
  spawnConfetti(220,c);
}
function spawnConfetti(n,c){
  confetti=[]; const cx=canvas.width/2, cy=canvas.height/2, base=(c==='green')?COLOR_GREEN:COLOR_BLUE;
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, sp=3+Math.random()*5;
    const clr=(Math.random()<.15)?'#ffffff':base;
    confetti.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1,life:120+Math.random()*60,clr:clr,size:2+Math.random()*3,rot:Math.random()*Math.PI});
  }
}
function stepConfetti(){
  for(let i=confetti.length-1;i>=0;i--){
    const p=confetti[i]; p.vy+=0.12; p.vx*=0.992; p.vy*=0.992; p.x+=p.vx; p.y+=p.vy; p.rot+=0.1; p.life--;
    if(p.life<=0) confetti.splice(i,1);
  }
}

/* ========= Tour suivant ========= */
function endOfTurn(){
  if(!playerColors[1]) return; // tant que les √©quipes ne sont pas fix√©es
  if(gainedThisTurn>0 && lostThisTurn===0){
    // rejoue
  }else{
    currentPlayer=(currentPlayer===1)?2:1;
  }
  gainedThisTurn=0; lostThisTurn=0;

  const midX=canvas.width*0.5, launchY=canvas.height*0.10;
  ball.x=midX; ball.y=(currentPlayer===1?canvas.height-launchY:launchY);
  ball.vx=0; ball.vy=0; ball.active=false;
  renderBadge();
}

/* ========= Physique ========= */
function step(){
  stepConfetti();

  if(ball && ball.active){
    ball.x+=ball.vx; ball.y+=ball.vy; ball.vx*=FRICTION; ball.vy*=FRICTION; ball.age+=16;

    // murs
    if(ball.x<ball.r){ball.x=ball.r;ball.vx=-ball.vx*RESTIT;}
    if(ball.x>canvas.width-ball.r){ball.x=canvas.width-ball.r;ball.vx=-ball.vx*RESTIT;}
    if(ball.y<ball.r){ball.y=ball.r;ball.vy=-ball.vy*RESTIT;}
    if(ball.y>canvas.height-ball.r){ball.y=canvas.height-ball.r;ball.vy=-ball.vy*RESTIT;}

    // collisions balle-lumie
    for(let i=0;i<lumies.length;i++){
      collideBallLumie(ball, lumies[i]);
    }

    // arr√™t de la balle
    if(Math.abs(ball.vx)<0.05 && Math.abs(ball.vy)<0.05){ ball.active=false; endOfTurn(); }
  }

  // lumies -> d√©placement + murs
  for(let i=0;i<lumies.length;i++){
    const L=lumies[i]; let hit=false;
    L.x+=L.vx; L.y+=L.vy; L.vx*=ROLL_F; L.vy*=ROLL_F;
    if(L.x<L.r){L.x=L.r;L.vx=-L.vx*RESTIT;hit=true;}
    if(L.x>canvas.width-L.r){L.x=canvas.width-L.r;L.vx=-L.vx*RESTIT;hit=true;}
    if(L.y<L.r){L.y=L.r;L.vy=-L.vy*RESTIT;hit=true;}
    if(L.y>canvas.height-L.r){L.y=canvas.height-L.r;L.vy=-L.vy*RESTIT;hit=true;}
    if(hit) onLumieHit(L);
  }

  // collisions lumie-lumie
  for(let i=0;i<lumies.length;i++){
    for(let j=i+1;j<lumies.length;j++){
      collideLumies(lumies[i],lumies[j]);
    }
  }
}

function collideBallLumie(B,L){
  const dx=L.x-B.x, dy=L.y-B.y, d=Math.hypot(dx,dy), min=B.r+L.r;
  if(d>0 && d<min){
    const nx=dx/d, ny=dy/d, ov=min-d;
    B.x-=nx*ov*0.5; B.y-=ny*ov*0.5;
    L.x+=nx*ov*0.5; L.y+=ny*ov*0.5;

    const rvx=B.vx-L.vx, rvy=B.vy-L.vy;
    let vn=rvx*nx+rvy*ny;
    if(vn>0) return; // d√©j√† en s√©paration

    // impulse
    const j=-(1+RESTIT)*vn/2, jx=j*nx, jy=j*ny;
    B.vx+=jx; B.vy+=jy;
    L.vx-=jx; L.vy-=jy;

    // d√©clenche couleur sur vrai choc
    if(Math.abs(vn) > 0.08) onLumieHit(L);
  }
}

function collideLumies(A,B){
  const dx=B.x-A.x, dy=B.y-A.y, d=Math.hypot(dx,dy), min=A.r+B.r;
  if(d>0 && d<min){
    const nx=dx/d, ny=dy/d, ov=min-d;
    A.x-=nx*ov*0.5; A.y-=ny*ov*0.5;
    B.x+=nx*ov*0.5; B.y+=ny*ov*0.5;

    const rvx=A.vx-B.vx, rvy=A.vy-B.vy;
    let vn=rvx*nx+rvy*ny;
    const j=-(1+RESTIT)*vn/2, jx=j*nx, jy=j*ny;
    A.vx+=jx; A.vy+=jy; B.vx-=jx; B.vy-=jy;

    onLumieHit(A); onLumieHit(B);
  }
}

/* ========= Rendu ========= */
function drawDashed(x1,y1,x2,y2,seg,space){
  const dx=x2-x1, dy=y2-y1, len=Math.hypot(dx,dy); if(len===0) return;
  const nx=dx/len, ny=dy/len; let d=0, on=true, cx=x1, cy=y1;
  ctx.beginPath();
  while(d<len){
    let step=(on?seg:space); if(d+step>len) step=len-d;
    const sx=nx*step, sy=ny*step;
    if(on){ ctx.moveTo(cx,cy); ctx.lineTo(cx+sx,cy+sy); }
    cx+=sx; cy+=sy; d+=step; on=!on;
  }
  ctx.stroke();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // fond jour/nuit
  if(mode==='night'){
    const g=ctx.createRadialGradient(canvas.width*.5,canvas.height*.5,10,canvas.width*.5,canvas.height*.5,Math.max(canvas.width,canvas.height)*.8);
    g.addColorStop(0,'#16224a'); g.addColorStop(1,'#0b1020'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  }else{
    const g2=ctx.createLinearGradient(0,0,0,canvas.height); g2.addColorStop(0,'#6abf69'); g2.addColorStop(1,'#2e7d32');
    ctx.fillStyle=g2; ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // bases (demi-cercles)
  const rBase=Math.min(canvas.width,canvas.height)*0.10;
  ctx.beginPath(); ctx.arc(canvas.width*.5,0,rBase,0,Math.PI,true); ctx.fillStyle='rgba(255,255,255,0.22)'; ctx.fill();
  ctx.beginPath(); ctx.arc(canvas.width*.5,canvas.height,rBase,Math.PI,0,true); ctx.fillStyle='rgba(255,255,255,0.22)'; ctx.fill();

  // ligne m√©diane
  ctx.strokeStyle='rgba(255,255,255,0.35)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(canvas.width*.08, canvas.height*.5); ctx.lineTo(canvas.width*.92, canvas.height*.5); ctx.stroke();

  // lumies
  for(const L of lumies){
    ctx.beginPath(); ctx.arc(L.x,L.y,L.r*1.5,0,Math.PI*2); ctx.fillStyle='rgba(255,90,103,0.20)'; ctx.fill();
    const fill=(L.color==='red')?COLOR_RED:(L.color==='green'?COLOR_GREEN:COLOR_BLUE);
    ctx.beginPath(); ctx.arc(L.x,L.y,L.r,0,Math.PI*2); ctx.fillStyle=fill; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.stroke();
  }

  // luminator
  if(ball){
    ctx.beginPath(); ctx.arc(ball.x,ball.y,R_BALL,0,Math.PI*2);
    ctx.fillStyle='#ffd24a'; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,0.75)'; ctx.stroke();
  }

  // fl√®che (limit√©e √† ARROW_MAX)
  if(drag){
    const vx=drag.x-drag.sx, vy=drag.y-drag.sy, len=Math.hypot(vx,vy);
    const cap=Math.min(len, ARROW_MAX);
    const fx=drag.sx + (vx/len)*cap, fy=drag.sy + (vy/len)*cap;
    const ang=Math.atan2(vy,vx), l=12;

    ctx.strokeStyle='rgba(255,255,255,0.55)'; ctx.lineWidth=2;
    drawDashed(drag.sx, drag.sy, fx, fy, 6, 6);
    ctx.beginPath();
    ctx.moveTo(fx, fy);
    ctx.lineTo(fx - l*Math.cos(ang - Math.PI/6), fy - l*Math.sin(ang - Math.PI/6));
    ctx.moveTo(fx, fy);
    ctx.lineTo(fx - l*Math.cos(ang + Math.PI/6), fy - l*Math.sin(ang + Math.PI/6));
    ctx.stroke();
  }

  // confettis
  for(const p of confetti){
    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
    ctx.fillStyle=p.clr; ctx.fillRect(-p.size*0.5,-p.size*0.5,p.size,p.size);
    ctx.restore();
  }

  // √©cran de victoire ‚ÄúLUMIOS‚Äù
  if(gameOver){
    const cx=canvas.width/2, cy=canvas.height/2, R=Math.min(canvas.width,canvas.height)*0.30;
    ctx.fillStyle='#ffffff'; ctx.beginPath();
    const spikes=14; for(let k=0;k<spikes;k++){const ang=(k/spikes)*Math.PI*2, r=(k%2?R*0.55:R), x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r; (k?ctx.lineTo(x,y):ctx.moveTo(x,y));}
    ctx.closePath(); ctx.fill();
    ctx.font=Math.floor(R*0.45)+'px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle=(winColor==='green')?COLOR_GREEN:COLOR_BLUE;
    ctx.fillText('LUMIOS',cx,cy);
  }
}

/* ========= UI boutons ========= */
btnMode.onclick=function(){
  if(mode==='night'){ mode='day'; btnMode.textContent='‚òÄÔ∏è Jour'; btnMode.style.background='#4da6ff'; btnMode.style.color='#fff'; }
  else { mode='night'; btnMode.textContent='üåô Nuit'; btnMode.style.background='#38d67a'; btnMode.style.color='#000'; }
};

btnNext.onclick=function(){
  if(ball.active){ ball.active=false; ball.vx=ball.vy=0; }
  endOfTurn();
};
btnReplay.onclick=function(){
  gameOver=false; winColor=null; confetti=[]; playerColors={1:null,2:null};
  currentPlayer=1; layout();
};

/* ========= Timer + boucle ========= */
setInterval(function(){
  const sTotal=Math.floor((Date.now()-tStart)/1000);
  const m=Math.floor(sTotal/60), s=sTotal%60;
  elClock.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
},1000);

function loop(){ step(); draw(); requestAnimationFrame(loop); }

/* start */
resize(); layout(); renderBadge(); loop();
</script>
</body>
</html>
